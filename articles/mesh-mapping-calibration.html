<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Mesh Mapping | Bonvision </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Mesh Mapping | Bonvision ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/bonvision/BonVision/blob/main/docs/articles/mesh-mapping-calibration.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="&#160; Bonvision">
            &#160; Bonvision
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="mesh-mapping">Mesh Mapping</h1>

<p><strong>Protocol for producing a mesh-mapping file using Bonsai (EH, April 2021)</strong></p>
<h2 id="purpose">Purpose</h2>
<p>Mesh mapping is performed to generate a mapping from pixel space (x,y) to visual angle space (azimuth, elevation), or
equivalently cartesian coordinate space (x,y,z). Mesh mapping is generally required when the relationship between pixel space and
visual angle/cartesian coordinate space is non-trivial, such as when projecting onto a demispherical dome.</p>
<h2 id="hardware-required">Hardware required</h2>
<ul>
<li>The display surface for which you are producing a mesh map.</li>
<li>Laser pointer (ideally one that clicks to stay on/off).</li>
<li>System for accurately targeting laser pointer at a given azimuth and elevation (in degrees) from the perspective of the animal’s head position. We use a custom 3D printed part suitable for holding our laser pointer at intervals of 30 vertical degrees and a high-precision rotation mount for targeting specific azimuth angles. We use RSP1X15/M from ThorLabs.</li>
</ul>
<h2 id="overview">Overview</h2>
<p>We provide 3 Bonsai workflows and a Matlab script for producing a mesh mapping file for a curved display surface:</p>
<ol>
<li><em>MeshMapping_Generate</em> is for interactively generating an initial mesh mapping .csv file in Bonsai.</li>
<li>The Matlab script <em>MeshMapping_MatlabInterp.m</em> is for interpolating and formatting the Bonsai-generated mesh mapping .csv file for use with the BonVision MeshMapping node.</li>
<li><em>MeshMapping_showCheckerboard</em> draws a simple checkerboard to test the accuracy of your mesh mapping file.</li>
<li><em>MeshMapping_correctPositions</em> can be used to interactively adjust indiviudal points in your mesh mapping file.</li>
</ol>
<p>The final output is a .csv with 5 columns (no headers): (pos_X, pos_Y, norm_Az, norm_El, intensity).</p>
<p>where pos_X and pos_Y are normalised screen positions of each cooordinate, norm_Az and normEl are normalized azimuth and elevation co-ordinates of each position and intensity is desired intensity values for each co-ordinate (generally a column of 1's).</p>
<p>You can download the workflows from <a href="https://github.com/bonvision/examples/tree/master/ScreenCalibration/MeshMapping">here</a>.</p>
<h2 id="protocol">Protocol</h2>
<h3 id="step-1---generating-initial-mesh-map">Step 1 - Generating initial mesh map</h3>
<p>Open the <em>MeshMap_Generate workflow</em> and enter the required parameters:</p>
<ul>
<li>Height and Width of display projector (in pixels). E.g. Width = 1280, Height = 800.</li>
<li>The desired angular span of the display (HSpan for azimuth, VSpan for elevation). E.g. HSpan = 240, VSpan = 120.</li>
<li>The number of subdivisions of the angular space which you wish to perform (HSubdiv for azimuth and VSubdiv for elevation). These values generate the grid of angular points you will manually assign. E.g. for HSpan = 240 and HSubdiv = 12 there will be 13 equally spaced points (0:20:240) specified along the azimuth for each elevation separate elevation.</li>
<li>Specify the display device property of the CreateWindow node to the display you are mesh mapping (e.g. ‘Second’).</li>
<li>The filename for the Mesh Mapping .csv file.</li>
</ul>
<p>You can now start the workflow. A blank shader window should fill the display surface being mesh mapped and a grid of circles representing the points to be assigned should be displayed on the display device which is showing the Bonsai GUI. The green circle indicates the current point being assigned. If you cannot see the grid, select the visualiser for the DrawGrid node. You may need to restart the workflow/assign the first point before the grid appears.</p>
<p><img src="../images/MeshMapping/meshmap_correction.JPG" width="500" alt="Meshmap Grid"></p>
<p>Now work through the points to be assigned. For each point:</p>
<ol>
<li>Target the laser pointer at the angular position to be assigned.</li>
<li>Using the mouse, position the small rendered circle on the display being mesh mapped to align with the laser. Mouse Keys may be useful for the final positioning. Once you are satisfied with the position of the circle, click the left mouse key. You can then save this point by pressing the ‘d’ keyboard key.
The green circle on the grid of circles should now have moved to the next point to be assigned. Repeat the previous step.</li>
<li>If you wish to reassign a point you can right-click the mouse to move back to a previous point.</li>
</ol>
<p>Once you have assigned all the required points close the shader window and workflow.
The mesh mapping .csv file will be saved in the location you specified before starting the workflow.</p>
<p><img src="../images/MeshMapping/initial_point_mapping.JPG" width="500" alt="Initial Point Mapping"></p>
<p><em>positioning the cursor where the laser is pointing</em></p>
<h3 id="step-2---interpolating-and-formatting-the-mesh-mapping-file">Step 2 - Interpolating and formatting the mesh mapping file</h3>
<p>Open the matlab script <em>MeshMapping_MatlabInterp</em> or <em>MeshMapping_3DMatlabInterp</em>.
Assign the variables:</p>
<ul>
<li>input .csv filename</li>
<li>output .csv filename</li>
<li>Angular Span (in degrees, as assigned in the MeshMapping_Generate workflow).</li>
<li>Display Dim (in pixels, as assigned in the MeshMapping_Generate workflow).</li>
<li>interpolation resolution for both azimuth and elevation. We suggest values that are factors of the angular span values.</li>
</ul>
<p>If producing a sphere-mapping meshmap for 2D stimuli you can now run the script (you may need to adjust the .csv writing function depending on your matlab version).
You should now have an interpolated and correctly formatted mesh mapping .csv file to use in Bonsai.</p>
<p>If producing a cube-mapping meshmap for 3D stimuli the script will produce a .bin file which you must process using the python <em>interpolator.py</em> script (note: to be consolidated).
The output of the python script is a .bin file ready to use in your 3D bonsai workflow.</p>
<h3 id="step-3---testing-the-mesh-map">Step 3 - Testing the mesh map</h3>
<p>Open the Bonsai workflow <em>MeshMapping_drawCheckerboard</em>.</p>
<p>Point the filename property of the MeshMapping node to the output file from the Matlab script.</p>
<p>Set the Bottom/Top and Left/Right properties of the <em>OrthographicView</em> node as the limits of the azimuth and elevation co-ordinates being presented (related to HSpan and VSpan from Step 1). E.g. Bottom = -30, Top = 90, Left = -120, Right = 120.</p>
<p>Set the ExtentX and ExtentY of the DrawCheckerboard node as the HSpan and VSpan values from Step 1. Specify the desired number of rows and columns (VSubdiv and HSubdiv, for example).</p>
<p>Run the workflow and ensure the checkerboard is displayed correctly. Each square should cover an equal amount of angular space as viewed from the perspective of the animals head position. Corners of each square should lie along meridians and parallels of each other.</p>
<p>Note if the checkerboard renders with jagged edges then adjusting the interpolation values in Step 2 may provide a solution.</p>
<p><img src="../images/MeshMapping/checkerboard_error.jpg" width="500" alt="Checkboard Warping"></p>
<p><em>testing the meshmap with a checkerboard - note the warping in the bottom right</em></p>
<h3 id="step-4---refine-mesh-map-optional">Step 4 - Refine mesh map (optional)</h3>
<p>If step 3 demonstrated imperfections in the mesh map then you can choose to adjust individual points.</p>
<p>Open the Bonsai workflow <em>MeshMapping_correctPositions</em>.</p>
<p>Set the resolution values (Height and Width) of the shader window as per your initial settings used for mesh mapping generation. Ensure the shader window is pointing to the correct display device (e.g. ‘Second’). Specify the desired output filename of the corrected mesh mapping .csv file.</p>
<p>For each point you wish to adjust perform the following:</p>
<ul>
<li>Using the mouse move the cursor to the point you wish to adjust. Press the keyboard ‘g’ key to ‘get’ the point. Text will appear to notify you of the point you are adjusting (in angular coordinates). Move the mouse cursor to the new desired location (i.e. to an updated position specified by your laser pointer). Press ‘s’ to set the point. You can press 's' multiple times until you are satisified with the new placement.</li>
<li>Once you have finished making adjustments, press the ‘k’ key to save the new mesh map file.</li>
<li>The new file will have the same format as the output of the MeshMapping_Generate workflow. You should now perform steps 2 and 3 again to interpolate and test your mesh map. Repeat this process iteratively as required.</li>
</ul>
<p><img src="../images/MeshMapping/checkerboard_corrected.jpg" width="500" alt="Checkboard Warping"></p>
<p><em>correction worflow</em></p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/bonvision/BonVision/blob/main/docs/articles/mesh-mapping-calibration.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          &copy; 2024 Aman Saleem. Made with <a href="https://dotnet.github.io/docfx">docfx</a>
        </div>
      </div>
    </footer>
  </body>
</html>
